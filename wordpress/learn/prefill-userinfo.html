<!-- prefill-userinfo -->

<script>
  // Prefill user info
  var prefill = {
    "firstname": "",
    "lastname": "",
    "email": "",
    "phone": "",
    "role": "",
    "experience": "",
  };

  const params = getAllUrlParams();
  prefill.firstname = decodeURIComponent(params['firstname'] ?? "");
  prefill.lastname = decodeURIComponent(params['lastname'] ?? "");
  prefill.email = decodeURIComponent(params['email'] ?? "");
  prefill.phone = decodeURIComponent(params['phone'] ?? "");
  prefill.role = decodeURIComponent(params['role'] ?? "");
  prefill.experience = decodeURIComponent(params['experience'] ?? "");

  //from hubspot the link will contain "fb" if value is not present on their side. so "fb" == null
  for (var key in prefill) {
    if (prefill[key].includes("fb")) {
      prefill[key] = "";
    }
  }

  function mapExperience(oldCategory) {
    const categoryMapping = {
      "0-2": "0-2",
      "0-3": "0-2",
      "0-5": "3-4",
      "10+": "9-15",
      "10-15": "9-15",
      "11-15": "9-15",
      "15-20": "15+",
      "16-20": "15+",
      "20+": "15+",
      "3-4": "3-4",
      "3-8": "5-8",
      "4-6": "5-8",
      "5-10": "5-8",
      "5-8": "5-8",
      "6-10": "5-8",
      "7-10": "5-8",
      "9-15": "9-15",
      "15+": "15+"
    };
    return categoryMapping[oldCategory] || null;
  }
  function mapRole(oldRole) {
    const roleMapping = {
      "Software Engineer": "Software Engineer",
      "Engineering Manager / Director of Engineering": "Engineering Manager - any domain",
      "Data Engineer / Data Scientist": "Data Engineer",
      "iOS / Android Developer": "Front-end",
      "ML / AI": "Machine Learning / AI",
      "Project Manager / Product Manager": "Tech Product Manager",
      "QA / Testing": "Test Engineer / SDET / QE",
      "No / Little coding experience": "None of the above",
      "Back-end": "Back-end",
      "Front-end": "Front-end",
      "Full Stack": "Full Stack",
      "Data Engineer": "Data Engineer",
      "Data Science": "Data Science",
      "Machine Learning / AI": "Machine Learning / AI",
      "Product Manager (Tech)": "Tech Product Manager",
      "Technical Program Manager": "Technical Program Manager",
      "Test Engineer / SDET / QE": "Test Engineer / SDET / QE",
      "Android Developer": "Android Developer",
      "iOS Developer": "iOS Developer",
      "Cyber Security": "Cyber Security",
      "SRE / DevOps": "Site Reliability Engineer",
      "Embedded Software Engineer": "Embedded Software Engineer",
      "Cloud Engineer": "Cloud Engineer",
      "Application Packaging Engineer": "Other Software Engineers",
      "Other Software Engineers": "Other Software Engineers",
      "No Coding Experience": "None of the above",
      "Engineering Manager": "Engineering Manager - any domain",
      "Business Intelligence Analyst": "Data Analyst / Business Analyst",
      "Data Analyst/Business Analyst": "Data Analyst / Business Analyst",
      "Data Analyst / Business Analyst": "Data Analyst / Business Analyst",
      "None of the above": "None of the above",
      "Core Engineering/STEM degree": "Core Engineering",
      "Salesforce developer": "Salesforce developer",
      "DevOps Engineer": "DevOps Engineer",
      "Site Reliability Engineer": "Site Reliability Engineer",
      "Tech Product Manager": "Tech Product Manager",
      "Growth Product Manager": "Tech Product Manager",
      "Product Marketing Manager": "Product Manager (Non Tech)",
      "AWS Cloud Solutions Architect": "Cloud Engineer",
      "CRM/ERP Developer": "Other Software Engineers",
      "Cyber Security/Security Engineering": "Cyber Security",
      "Data Engineering": "Data Engineer",
      "Functional Consultants": "Other Software Engineers",
      "Embedded Systems": "Embedded Software Engineer",
      "Engineering Manager": "Engineering Manager - any domain",
      "Machine Learning/Deep Learning": "Machine Learning / AI",
      "Mobile Engineering (iOS/Android)": "Front-end",
      "Site Reliability Engineering": "Site Reliability Engineer",
      "Software Engineering (Frontend, Fullstack, Backend, Test)": "Software Engineer",
      "STEM Background": "Core Engineering",
      "Tech Consultants/IT Consultants": "Other Software Engineers",
      "Product Manager (Non Tech)": "Product Manager (Non Tech)"
    };
    return roleMapping[oldRole] || null;
  }

  prefill.experience = mapExperience(prefill.experience);
  prefill.role = mapRole(prefill.role);

  webinarType = params.webinarType || webinarType;
  eventName = decodeURIComponent(params.event ?? "") || "How to nail your next Technical Interview";

  const isCoreDataMissing = !prefill.email
  const isSomeDataMissing = !prefill.firstname || !prefill.phone || !prefill.role || !prefill.experience;
  let slotsLoaded = false;

  function track(step, message) {
    typeof saveFormEventsActivity === 'function' ? saveFormEventsActivity(step, null, null, message) : console.error("saveFormEventsActivity is not a function");
  }

  if (isCoreDataMissing) {
    console.log("email is missing. falling back to the normal flow");
    document.querySelector(".form_1").style.display = "none";
    document.querySelector(".form_2").style.display = "block";
  }

  const slotsFetched = (slots) => {
    slotsLoaded = true;
    const mainConatiner = document.querySelector(".v2_from_wrapper");
    const fallbackContainer = document.querySelector(".v2_from_wrapper_2");
    mainConatiner.setAttribute("loader_status", "false")

    const slideField = mainConatiner.querySelector(".slot_fild");
    slideField.innerHTML = "";

    const fallbackSlideField = fallbackContainer.querySelector(".slot_fild");
    fallbackSlideField.innerHTML = "";

    slots.forEach(function (slot, index) {
      let createWebniarSlot = document.createElement("label");
      createWebniarSlot.classList.add("slot");

      let slotInner = `
        <input type="radio" 
        name="v2_slot" 
        class="v2_slot_radio"
        value="${slot.start_time}"
        data-endtime="${slot.end_time}" 
        data-invitee_starttime="${slot.invitee_start_time}" 
        data-invitee_endtime="${slot.invitee_end_time}" 
        data-name="${slot.start_time}" 
        data-webinar_lead_type="${slot.webinar_lead_type}" 
        ${index === 0 ? "checked" : ""}
        slot-index="${index}" >
        <div class="time_slot_wrapper">
            <div class="v2_day">${slot.weekday.slice(0, 3).toUpperCase()}</div>
            <div class="v2_date">${slot.day}</div>
            <hr>
            <div class="v2_time">${slot.hour}:${slot.minute} ${slot.am_or_pm}</div>
        </div>
      `;

      if (index === 0) {
        slotInner += `
          <div class="v2_timer_alart" alart_type="warning">
              Filling fast
          </div>
        `;
      } else if (slot.weekday === "Saturday") {
        slotInner += `
          <div class="v2_timer_alart" alart_type="danger">
              Almost full
          </div>
        `;
      }

      createWebniarSlot.innerHTML = slotInner;
      slideField.appendChild(createWebniarSlot);
      fallbackSlideField.appendChild(createWebniarSlot.cloneNode(true));
    })
  }

  document.addEventListener("webNearLoaded", function () {
    slotsFetched(webinarSlots);
  })
  document.addEventListener("staticSlotsLoaded", function () {
    slotsFetched(webinarSlots);
  });


  window.addEventListener("DOMContentLoaded", function () {
    const getThePopupFrom2 = document.querySelector('.v2_from_wrapper');
    !slotsLoaded && getThePopupFrom2.setAttribute("loader_status", "true");

    getThePopupFrom2.querySelector(".time_zone").innerHTML = `Time Zone: ${v_timezone}`;

    const webinarFullName2 = getThePopupFrom2.querySelector('input.fr_name_fl');
    const webinarPhoneNumber2 = getThePopupFrom2.querySelector('.fr_phone_fl');

    const getDomainRole = getThePopupFrom2.querySelector('.gql_domain_select');
    const getExperience = getThePopupFrom2.querySelector('.gql_exp_select');

    const errDomain = getThePopupFrom2.querySelector('.v2_dom_fild');
    const errExperience = getThePopupFrom2.querySelector('.v2_exp_fild');
    const webinarSlots2 = getThePopupFrom2.querySelector('.slot_sl_con .slot_fild');

    const getFnErrMsg2 = getThePopupFrom2.querySelector('.v2_full_name');
    const getPhErrMsg2 = getThePopupFrom2.querySelector('.v2_phone_number');
    getFnErrMsg2.querySelector(".err_fild").innerHTML = getFnErrMsg2.querySelector(".err_fild").innerHTML.replace("first", "your");

    document.addEventListener("webNearLoaded", function () {
      !isCoreDataMissing && visitorTrackingS4(true);
    })

    function prefillData() {
      if (prefill.firstname) {
        let fullname = prefill.firstname;
        if (prefill.lastname) {
          fullname += ` ${prefill.lastname}`;
        }
        webinarFullName2.value = fullname;
      }

      if (prefill.phone) {
        webinarPhoneNumber2.value = prefill.phone;
      }

      if (prefill.role) {
        getDomainRole.value = prefill.role;
      }
      if (prefill.experience) {
        let experienceSelector = getExperience.querySelector(`input[value="${prefill.experience}"]`);
        if (experienceSelector) {
          experienceSelector.checked = true;
        }
      }
    }
    prefillData();

    function initializeIntlTelInput(selector, phoneNumber, geoData) {
      const input = getThePopupFrom2.querySelector(selector);
      if (!input) return null;
      const instance = window.intlTelInput(input, {
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
        initialCountry: "auto",
        formatOnDisplay: false,
        geoIpLookup: function (callback) {
          callback(geoData.country_code);
        },
      });

      // If the phone number starts with '+', set it directly
      if (phoneNumber.startsWith("+")) {
        instance.setNumber(phoneNumber);
      } else {
        // If no country code is present, set the country flag based on geoData
        instance.setNumber(phoneNumber);
        instance.setCountry(geoData.country_code);
      }

      return instance;
    }
    const webinarPhoneNumberWri2 = initializeIntlTelInput(".fr_phone_fl", prefill.phone, { country_code: geoData.country_code });

    // name container
    const webinarInfo2 = {
      firstName: prefill.firstname,
      lastName: prefill.lastname,
      fPhoneNumber: prefill.phone,
      utm_source: "",
      utm_medium: "",
      utm_campaign: "",
      utm_adset: "",
      utm_content: "",
      utm_term: "",
      page_url: page_url,
      site_url: window.location.hostname,
      user_id: "",
      gclid: "",
      salesforce_uuid: "",
      msclkid: "",
      fbclid: "",
      fbcId: null,
      fbpId: null,
      userAgent: "",
      li_fat_id: "",
      user_timezone: "",
      l_page_url: "",
      cta_page_url: "",
      webinar_type: "",
      eventname: "",
      wr__referrer: "",
      wr__device: "",
      webinar_lead_type: "",
      bye_calendly_type: "",
      is_exit_intent_popup: "",
      v_country: "",
      wr__region: "",
      wr__city: "",
      irclickid: "",
      eventStartTime: "",
      eventEndTime: "",
      inviteStartTime: "",
      inviteEndTime: "",
    };

    let isUpdating = false;
    let name_regex2 = new RegExp("^[a-zA-Z ]+$");
    let phone_regex2 = /^(\+\d{1,2}\s?)?1?\-?\.?\s?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$/;

    // getlocation json
    (async function () {
      let response = await fetch("https://get.geojs.io/v1/ip/geo.json");
      let data = await response.json();
      webinarInfo2.v_country = data.country;
      webinarInfo2.wr__region = data.region;
      webinarInfo2.wr__city = data.city;
    })();

    function getCookieValue(cookieName) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${cookieName}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function getPhoneNumber(controller, selector) {
      phoneNumber = "";
      if (typeof intlTelInputUtils == "undefined") {
        try {
          phoneNumber = `+${controller.getSelectedCountryData().dialCode || ""}${getThePopupFrom2.querySelector(selector)?.value}`;
        } catch (error) {
          console.error("Error while getting phone number", error);
          phoneNumber = getThePopupFrom2.querySelector(selector)?.value;
        }
      } else {
        phoneNumber = controller.getNumber(intlTelInputUtils.numberFormat.E164);
      }
      return phoneNumber;
    }
    
    getDomainRole.addEventListener('change', function () {
      errDomain.setAttribute('err_status', false);
    })
    
    errExperience.addEventListener('change', function () {
      errExperience.setAttribute('err_status', false);
    })

    function setHiddenFields2() {
      //  let params = read_cookie("v_latest");
      let params = [];
      try {
        params = read_cookie("v_latest") || getAllUrlParams();
        bake_cookie("v_latest", params);
      } catch (error) {
        console.error("Error while reading cookie", error);
      }
      const fbcFromCookies = getCookieValue('_fbc');
      const fbp = getCookieValue('_fbp');
      const userAgent = navigator?.userAgent;
      const fbclid = decodeURIComponent(params['fbclid'] || "");
      let fbc = fbcFromCookies;
      if (!fbcFromCookies && fbclid) {
        // Generate fbc from fbclid
        const domainParts = window.location.hostname.split('.');
        const subdomainIndex = domainParts.length - 1;
        const creationTime = Date.now();
        fbc = `fb.${subdomainIndex}.${creationTime}.${fbclid}`;
      }
      webinarInfo2.utm_source = decodeURIComponent(params['utm_source'] || "Organic");
      webinarInfo2.utm_medium = decodeURIComponent(params['utm_medium'] || "");
      webinarInfo2.utm_campaign = decodeURIComponent(params['utm_campaign'] || "");
      webinarInfo2.utm_content = decodeURIComponent(params['utm_content'] || "");
      webinarInfo2.utm_term = decodeURIComponent(params['utm_term'] || "");
      webinarInfo2.utm_adset = decodeURIComponent(params['utm_adset'] || "");
      webinarInfo2.gclid = decodeURIComponent(params['utm_term'] || "");
      webinarInfo2.salesforce_uuid = decodeURIComponent(params['salesforce_uuid'] || "");
      webinarInfo2.msclkid = decodeURIComponent(params['msclkid'] || "");
      webinarInfo2.fbclid = fbclid;
      webinarInfo2.fbcId = fbc || null;
      webinarInfo2.fbpId = fbp || null;
      webinarInfo2.userAgent = userAgent;
      webinarInfo2.li_fat_id = decodeURIComponent(params['li_fat_id'] || "");

      webinarInfo2.user_id = visitor_id;
      webinarInfo2.user_timezone = v_timezone;
      //     webinarInfo2.l_page_url = "learn.ik" + getCookie("ik-landingpage");
      if ((referrer || '') != "") {
        webinarInfo2.l_page_url = "learn.ik/" + (referrer || '').split("/").pop();
      } else {
        webinarInfo2.l_page_url = "learn.ik/" + page_url.split("/").pop();
      }
      webinarInfo2.cta_page_url = "learn.ik" + cta_lp;
      webinarInfo2.webinar_type = webinarType;
      webinarInfo2.eventname = eventName;
      webinarInfo2.wr__referrer = referrer;
      webinarInfo2.wr__device = getDeviceType();

      webinarInfo2.webinar_lead_type = webinarType;
      webinarInfo2.bye_calendly_type = "";
      webinarInfo2.is_exit_intent_popup = "No";
      webinarInfo2.irclickid = decodeURIComponent(params['irclickid'] || "");
    }
    setHiddenFields2();

    async function pushToEndPoint2(endpoint) {
      let getCheckwebinar = webinarSlots2.querySelector('input[name="v2_slot"]:checked');
      if (!getCheckwebinar) {
        track("slot-e", "slot-not-selected");
        getThePopupFrom2.querySelector(".from_step_1").setAttribute("err_status", true);
        throw new Error("Slot not selected");
      }
      getThePopupFrom2.querySelector(".from_step_1").setAttribute("err_status", false);

      webinarInfo2.eventStartTime = getCheckwebinar.value;
      webinarInfo2.eventEndTime = getCheckwebinar.getAttribute('data-endtime');
      webinarInfo2.inviteStartTime = getCheckwebinar.getAttribute('data-invitee_starttime');
      webinarInfo2.inviteEndTime = getCheckwebinar.getAttribute('data-invitee_endtime');

      let formData = {
        "First Name": webinarInfo2.firstName,
        "Last Name": webinarInfo2.lastName,
        "Email Address": prefill.email,
        "ByeCalendlyType": webinarInfo2.bye_calendly_type,
        "webinar-type": webinarInfo2.webinar_type,
        "Webinar Lead Type": webinarInfo2.webinar_lead_type,
        "utm_source": webinarInfo2.utm_source,
        "utm_medium": webinarInfo2.utm_medium,
        "utm_campaign": webinarInfo2.utm_campaign,
        "utm_content": webinarInfo2.utm_content,
        "utm_adset": webinarInfo2.utm_adset,
        "utm_term": webinarInfo2.utm_term,

        "City": webinarInfo2.wr__city,
        "Device": webinarInfo2.wr__device,
        "Referrer": webinarInfo2.wr__referrer,
        "Region": webinarInfo2.wr__region,

        "gclid": webinarInfo2.gclid,
        "msclkid": webinarInfo2.msclkid,
        "fbclid": webinarInfo2.fbclid,
        "fbpId": webinarInfo2.fbpId,
        "fbcId": webinarInfo2.fbcId,
        "user_agent": webinarInfo2.userAgent,
        "user_id": webinarInfo2.user_id,
        "li_fat_id": webinarInfo2.li_fat_id,

        "cta_page_url": webinarInfo2.cta_page_url,
        "landing_page_url": webinarInfo2.l_page_url,
        "event_name": webinarInfo2.eventname,
        "user_timezone": webinarInfo2.user_timezone,
        "page_url": webinarInfo2.page_url,
        "site_url": webinarInfo2.site_url,
        "v_country": webinarInfo2.v_country,
        "salesforce_uuid": webinarInfo2.salesforce_uuid,
        "phone_number_full": webinarInfo2.fPhoneNumber,
        "is_exit_intent_popup": webinarInfo2.is_exit_intent_popup,
        "irclickid": webinarInfo2.irclickid,

        "Event Start Time": webinarInfo2.eventStartTime,
        "Event End Time": webinarInfo2.eventEndTime,
        "Invitee Start Time": webinarInfo2.inviteStartTime,
        "Invitee End Time": webinarInfo2.inviteEndTime,
        ...userIpAndBrowserInfo
      };

      let options = {
        method: 'POST',
        mode: "no-cors",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      };

      try {
        const sendData = await fetch(endpoint, options);
        return sendData;
      } catch (err) {
        console.error("P0: The Zapier Webhook Failed.", err);
      }
    }

    function hideError2() {
      getFnErrMsg2.setAttribute('err_status', false);
      getPhErrMsg2.setAttribute('err_status', false);
    }

    async function visitorTrackingS4(forSlotAPI = false ) {
      //lead LeadCreatedTime
      const currentDateTime = new Date();
      const LeadCreatedTime = currentDateTime.toISOString().replace(/T/, ' ').replace(/\.\d+Z$/, ' UTC');

      function formatDateTime(dateTimeString) {
        const date = new Date(dateTimeString);
        const year = date.getUTCFullYear();
        const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
        const day = date.getUTCDate().toString().padStart(2, '0');
        const hours = date.getUTCHours().toString().padStart(2, '0');
        const minutes = date.getUTCMinutes().toString().padStart(2, '0');
        const seconds = date.getUTCSeconds().toString().padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} UTC`;
      }

      let formattedStartDateTime = null;
      let formattedEndDateTime = null;
      if(!forSlotAPI){
        const getCheckwebinar = webinarSlots2.querySelector('input[name="v2_slot"]:checked');
        formattedStartDateTime = formatDateTime(getCheckwebinar.value);
        formattedEndDateTime = formatDateTime(getCheckwebinar.getAttribute('data-endtime'));
      }

      let data = [{
        "Lead_Created_Time": forSlotAPI ? currentDateTime : LeadCreatedTime,
        "Lead_Name": webinarInfo2.firstName + ' ' + webinarInfo2.lastName,
        "Lead_First_Name": webinarInfo2.firstName,
        "Lead_Last__Name": webinarInfo2.lastName,
        "Lead_Email": prefill.value,
        "Lead_Time_Zone": webinarInfo2.user_timezone,
        "Event_Type_Name": eventName,
        "Event_Start_Date_Time": formattedStartDateTime,
        "Event_End_Date_Time": formattedEndDateTime,
        "Cancellation_reason": "",
        "Mobile": webinarInfo2.fPhoneNumber,
        "UTM_Campaign": webinarInfo2.utm_campaign,
        "UTM_Source": webinarInfo2.utm_source,
        "UTM_Medium": webinarInfo2.utm_medium,
        "UTM_Term": webinarInfo2.utm_term,
        "UTM_Content": webinarInfo2.utm_content,
        "Tracking_ID": "",
        "User_ID": webinarInfo2.user_id,
        "Page_URL": encodeURIComponent(webinarInfo2.page_url),
        "Country": webinarInfo2.v_country,
        "Client_Timezone": webinarInfo2.user_timezone,
        "CTA_Page": encodeURIComponent(webinarInfo2.cta_page_url),
        "Landing_Page": encodeURIComponent(webinarInfo2.l_page_url),
        "Webinar_reg_type": "",
        "Webinar_Type": webinarInfo2.webinar_type,
        "Switchup_Lead": webinarInfo2.webinar_lead_type,
        "UUID": webinarInfo2.salesforce_uuid,
        "Click_History": "",
        "City": webinarInfo2.wr__city,
        "Device": webinarInfo2.wr__device,
        "User_Agent": encodeURIComponent(navigator?.userAgent || ""),
        "Refferer": encodeURIComponent(webinarInfo2.wr__referrer),
        "Region": webinarInfo2.wr__region,
        "step": "s4"
      }];

      if(forSlotAPI) {
        data = [{
          ...data[0],
          "step": "s1_slotsAPI"
        }];
      }

      let options = {
        method: 'POST',
        headers: {
          'x-api-key': 'fm0X61U99b80d5SlGjrxFaWjgxIBylhX3LkfYGPN',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          dataset_id: "Marketing_data_new_logic",
          table_id: "Leads_Click_history",
          data: data,
        }),
        keepalive: true,
      };

      try {
        const response = await fetch('https://nlhtyrnugl.execute-api.us-west-1.amazonaws.com/prod', options);
        return response;
      } catch (err) {
        console.log(err);
      };
    }

    function loadPagefield() {
      const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

      const getCheckwebinar = webinarSlots2.querySelector('input[name="v2_slot"]:checked');
      const getFullData = webinarSlots[parseInt(getCheckwebinar.getAttribute("slot-index"))];

      const eventDateSelector = document.querySelector('.selected_web_event');

      const day = parseInt(getFullData.day);
      const hour = parseInt(getFullData.hour);

      const daySuffix = (day % 10 === 1 && day !== 11) ? "st" :
        (day % 10 === 2 && day !== 12) ? "nd" :
          (day % 10 === 3 && day !== 13) ? "rd" : "th";

      eventDateSelector.innerHTML = `${getFullData.weekday}, ${day}${daySuffix} ${months[parseInt(getFullData.month) - 1]} · ${hour}-${hour + 1} ${getFullData.am_or_pm}`;

      const getDayfield = document.querySelector('#v2-success-day');
      const getDatefield = document.querySelector('#v2-success-date');
      const getMonthfield = document.querySelector('#v2-success-month');
      const getTimefield = document.querySelector('#v2-success-time');

      getDayfield.innerHTML = getFullData.weekday;
      getDatefield.innerHTML = getFullData.day;
      getMonthfield.innerHTML = months[parseInt(getFullData.month) - 1];
      getTimefield.innerHTML = `${getFullData.hour}:${getFullData.minute} ${getFullData.am_or_pm}`;

    }

    async function sendRequestZapiar(url, data) {
      let options = {
        method: 'POST',
        mode: "no-cors",
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      };

      try {
        let response = await fetch(url, options);
        getThePopupFrom2.setAttribute("active_step", 3);
        if(isUpdating) {
          saveClickActivity("info_and_gql_updated");
        } else {
          saveClickActivity("info_and_gql_confirmed");
        }

      } catch (error) {
        if(isUpdating) {
          saveClickActivity("info_and_gql_update-error-calling-zapier");
        } else {
          saveClickActivity("info_and_gql_confirm-error-calling-zapier");
        }
        console.error("error in zapier webhook", error);
      }
    }

    function slotFormSubmission() {
      pushToEndPoint2("https://hooks.zapier.com/hooks/catch/11068981/340hl1a/")
        .then(() => {
          getThePopupFrom2.setAttribute("active_step", 2);
          loadPagefield();
          saveClickActivity("webinar_slot_selected")
          visitorTrackingS4();
        }).catch((e) => {
          console.error(e)
          saveClickActivity("webinar_slot_selected-error-calling-zapier")
        });
    }

    function infoFormSubmitToZap(newDetails = null) {
      let v2WorkExp = newDetails ? newDetails.years_of_work_experience : getExperience.querySelector('input[name="exp_options"]:checked').value;
      let v2DomExp = newDetails ? newDetails.current_job_role : getDomainRole.value;

      let gqlErrStatus = false;

      if (!v2DomExp) {
        gqlErrStatus = true;
        errDomain.setAttribute('err_status', gqlErrStatus);
      }

      if (!v2WorkExp) {
        gqlErrStatus = true;
        errExperience.setAttribute('err_status', gqlErrStatus);
      }

      if (!gqlErrStatus) {
        let GQLformData = {
          "First Name": newDetails ? newDetails.first_name : webinarInfo2.firstName,
          "Last Name": newDetails ? newDetails.last_name : webinarInfo2.lastName,
          "Email Address": prefill.email,
          "utm_source": webinarInfo2.utm_source,
          "utm_medium": webinarInfo2.utm_medium,
          "utm_campaign": webinarInfo2.utm_campaign,
          "utm_term": webinarInfo2.utm_term,
          "gclid": webinarInfo2.gclid,
          "msclkid": webinarInfo2.msclkid,
          "fbclid": webinarInfo2.fbclid,
          "fbpId": webinarInfo2.fbpId,
          "fbcId": webinarInfo2.fbcId,
          "user_agent": webinarInfo2.userAgent,
          "user_id": visitor_id,
          "user_timezone": v_timezone,
          "v_country": v_country,
          "phone_number_full": newDetails ? newDetails.phone_number : webinarInfo2.fPhoneNumber,
          "Event Start Time": webinarInfo2.eventStartTime,
          "Event End Time": webinarInfo2.eventEndTime,
          "Work Experience": v2WorkExp,
          "Role Domain": v2DomExp,
          "Interview Start Time": "",
          "Laid Off": "",
          "Is Student": "",
          "salesforce_uuid": webinarInfo2.salesforce_uuid,
        };

        try {
          dataLayer.push({
            event: "wordpress_form_submitted",
            formName: "Lead Qualifier Form",
          })
        } catch (err) {
          saveClickActivity("info_and_gql_update-error-in-data-layer-push");
          console.log("error in data layer push", err);
        }
        let zapUrl = "https://hooks.zapier.com/hooks/catch/11068981/3409hxu/";

        sendRequestZapiar(zapUrl, GQLformData);
      } else {
        saveClickActivity("info_and_gql_update-error-validation-general");
        // track("gql-e", "validation-gql");
      }
    }

    function validateDetails() {
      let fullname = webinarFullName2.value.trim();
      let fullPhoneNumber = webinarPhoneNumber2.value;

      webinarFullName2.addEventListener('input', hideError2);
      webinarPhoneNumber2.addEventListener('input', hideError2);
      webinarFullName2.addEventListener('focus', hideError2);
      webinarPhoneNumber2.addEventListener('focus', hideError2);

      let v2WorkExp = getExperience.querySelector('input[name="exp_options"]:checked');
      let v2DomExp = getDomainRole.value;

      let gqlErrStatus = false;

      if ((fullname.length == 0) && (fullPhoneNumber.length == 0)) {
        getFnErrMsg2.setAttribute('err_status', true);
        getPhErrMsg2.setAttribute('err_status', true);
        saveClickActivity("info_and_gql_update-error-validation-general");
        return false;
      } else if (!name_regex2.test(fullname) || fullname.length == 0) {
        getFnErrMsg2.setAttribute('err_status', true);
        saveClickActivity("info_and_gql_update-error-validation-name");
        return false;
      } else if (!phone_regex2.test(fullPhoneNumber) || fullPhoneNumber.length == 0) {
        getPhErrMsg2.setAttribute('err_status', true);
        saveClickActivity("info_and_gql_update-error-validation-phone");
        return false;
      } else if (!v2DomExp) {
        gqlErrStatus = true;
        errDomain.setAttribute('err_status', gqlErrStatus);
        saveClickActivity("info_and_gql_update-error-validation-domain");
        return false;
      } else if (!v2WorkExp) {
        gqlErrStatus = true;
        errExperience.setAttribute('err_status', gqlErrStatus);
        saveClickActivity("info_and_gql_update-error-validation-exp");
        return false;
      }
      return true;

    }

    async function updateDetails() {
      if (!validateDetails()) {
        return;
      }

      var fullName = getThePopupFrom2.querySelector(".fr_name_fl").value;

      var nameParts = fullName.split(/\s+/);
      var firstName = nameParts[0];
      var lastName = "";

      if (nameParts.length > 1) {
        lastName = nameParts.slice(1).join(" ");
      }

      const newDetails = {
        first_name: firstName,
        last_name: lastName,
        phone_number: getPhoneNumber(webinarPhoneNumberWri2, ".fr_phone_fl"),
        current_job_role: getThePopupFrom2.querySelector(".gql_domain_select").value,
        years_of_work_experience: getThePopupFrom2.querySelector(".gql_exp_select input:checked").value,
        email: prefill.email,
      }

      infoFormSubmitToZap(newDetails);

      // const url = 'https://uplevel.interviewkickstart.com/api/interested-candidate/update-interested-candidate/';
      // try {
      //   const response = await fetch(url, {
      //     method: 'POST',
      //     headers: {
      //       "Authorization": "Token 0b8bf4edc533bf581b7b368ae7bed73377fae3b1",
      //       "Content-Type": "application/json",
      //     },
      //     body: JSON.stringify(newDetails)
      //   });

      //   if (!response.ok) {
      //     throw new Error(`HTTP error! Status: ${response.status}`);
      //     saveClickActivity("info_and_gql_updated-error-in-uplevel-api");
      //   } else {
      //     saveClickActivity("info_and_gql_updated");
      //     getThePopupFrom2.setAttribute("active_step", 3);
      //   }
      //   const responseData = await response.json();
      // } catch (error) {
      //   saveClickActivity("info_and_gql_updated_error");
      //   console.error('Error:', error);
      // }
    }

    function toggleEdit() {
      isUpdating = !isUpdating;

      const nameField = getThePopupFrom2.querySelector(".fr_name_fl");
      const phoneField = getThePopupFrom2.querySelector(".fr_phone_fl");
      const domainSelect = getThePopupFrom2.querySelector(".gql_domain_select");
      const expOptions = getThePopupFrom2.querySelectorAll(".exp_options");
      const expSelect = getThePopupFrom2.querySelector(".gql_exp_select");
      const submitBtn = getThePopupFrom2.querySelector(".step_btn_2");
      const cancelBtn = getThePopupFrom2.querySelector(".step_back_2");

      if (isUpdating) {
        cancelBtn.innerHTML = "Cancel";
        submitBtn.innerHTML = "Update Details";
        nameField.removeAttribute("disabled");
        phoneField.removeAttribute("disabled");
        domainSelect.removeAttribute("disabled");
        expOptions.forEach(option => option.removeAttribute("disabled"));
        expSelect.removeAttribute("disabled");
        saveClickActivity("info_and_gql_combined_edit");
      } else {
        cancelBtn.innerHTML = "Edit Details";
        submitBtn.innerHTML = "Confirm";
        prefillData()
        hideError2()
        if (window.intlTelInputGlobals) {
          const itiInstance = intlTelInputGlobals.getInstance(phoneField);
          if (itiInstance) {
            itiInstance.setNumber(prefill.phone);
          } else {
            phoneField.value = prefill.phone;
          }
        } else {
          phoneField.value = prefill.phone;
        }

        nameField.setAttribute("disabled", "true");
        phoneField.setAttribute("disabled", "true");
        domainSelect.setAttribute("disabled", "true");
        expOptions.forEach(option => option.setAttribute("disabled", "true"));
        expSelect.setAttribute("disabled", "true");
        saveClickActivity("info_and_gql_combined_cancel_edit");
      }
    }

    if (isSomeDataMissing) {
      toggleEdit();
      isUpdating = true;
      getThePopupFrom2.querySelector('.step_btn_2').innerHTML = "Confirm";
      getThePopupFrom2.querySelector('.step_back_2').style.display = "none";
      getThePopupFrom2.querySelector('.step_btn_2').style.width = "100%";
    }

    const getV2Btn1 = getThePopupFrom2.querySelector('.step_btn_1');
    const getV2Btn2 = getThePopupFrom2.querySelector('.step_btn_2');

    const getV2Back2 = getThePopupFrom2.querySelector('.step_back_2');

    getV2Btn1.addEventListener("click", () => {
      try {
        slotFormSubmission();
      } catch (error) {
        console.error(error)
        saveFormEventsActivity("slot-e", null, null, "Error in 1st step");
      }
    });
    getV2Btn2.addEventListener("click", () => {
      try {
        if (isUpdating) {
          updateDetails();
        } else {
          infoFormSubmitToZap();
          getThePopupFrom2.setAttribute("active_step", 3);
        }
      } catch (error) {
        console.error(error)
        saveFormEventsActivity("gql-e", null, null, "Error in 3rd step");
      }
    });

    getV2Back2.addEventListener("click", toggleEdit)
  })
</script>


<!-- fallback flow incase of email is not present on  -->
<script>
  (function () {
    window.addEventListener("DOMContentLoaded", function () {
      
      const getThePopupFrom2 = document.querySelector('.v2_from_wrapper_2');
      getThePopupFrom2.querySelector(".time_zone").innerHTML = `Time Zone: ${v_timezone}`;

      const webNearFullName2 = getThePopupFrom2.querySelector('input.fr_name_fl');
      const webNearEmailAddress2 = getThePopupFrom2.querySelector('.fr_email_fl');
      const webNearPhoneNumber2 = getThePopupFrom2.querySelector('.fr_phone_fl');

      const webNearSlots2 = getThePopupFrom2.querySelector('.slot_sl_con .slot_fild');

      const webNearPhoneNumberWri2 = window.intlTelInput(webNearPhoneNumber2, {
        initialCountry: "auto",
        geoIpLookup: function (callback) {
          fetch('https://ipinfo.io', { headers: { 'Accept': 'application/json' } })
            .then((resp) => resp.json())
            .then((resp) => { callback(resp.country); })
            .catch(() => callback('in'));
        },
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
      });

      const getFnErrMsg2 = getThePopupFrom2.querySelector('.v2_full_name');
      const getEmErrMsg2 = getThePopupFrom2.querySelector('.v2_email');
      const getPhErrMsg2 = getThePopupFrom2.querySelector('.v2_phone_number');

      // name container
      const webNearInfo2 = {
        firstName: "",
        lastName: "",
        fPhoneNumber: "",
        utm_source: "",
        utm_medium: "",
        utm_campaign: "",
        utm_adset: "",
        utm_content: "",
        utm_term: "",
        page_url: page_url,
        site_url: window.location.hostname,
        user_id: "",
        gclid: "",
        salesforce_uuid: "",
        msclkid: "",
        fbclid: "",
        fbcId: null,
        fbpId: null,
        userAgent: "",
        li_fat_id: "",
        user_timezone: "",
        l_page_url: "",
        cta_page_url: "",
        webinar_type: "",
        eventname: "",
        wr__referrer: "",
        wr__device: "",
        webinar_lead_type: "",
        bye_calendly_type: "",
        is_exit_intent_popup: "",
        v_country: "",
        wr__region: "",
        wr__city: "",
        irclickid: "",

        eventStartTime: "",
        eventEndTime: "",
        inviteStartTime: "",
        inviteEndTime: "",
      };

      //check regex
      let name_regex2 = new RegExp("^[a-zA-Z ]+$");
      let email_regex2 = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
      let phone_regex2 = /^(\+\d{1,2}\s?)?1?\-?\.?\s?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$/;

      // getlocation json
      (async function () {
        let response = await fetch("https://get.geojs.io/v1/ip/geo.json");
        let data = await response.json();
        webNearInfo2.v_country = data.country;
        webNearInfo2.wr__region = data.region;
        webNearInfo2.wr__city = data.city;
      })();

      function getCookieValue(cookieName) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${cookieName}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      function setHiddenFields2() {
        //  let params = read_cookie("v_latest");
        let params = [];
        try {
          params = read_cookie("v_latest") || getAllUrlParams();
          bake_cookie("v_latest", params);
        } catch (error) {
          console.error("Error while reading cookie", error);
        }
        const fbcFromCookies = getCookieValue('_fbc');
        const fbp = getCookieValue('_fbp');
        const userAgent = navigator?.userAgent;
        const fbclid = decodeURIComponent(params['fbclid'] || "");
        let fbc = fbcFromCookies;
        if (!fbcFromCookies && fbclid) {
          // Generate fbc from fbclid
          const domainParts = window.location.hostname.split('.');
          const subdomainIndex = domainParts.length - 1;
          const creationTime = Date.now();
          fbc = `fb.${subdomainIndex}.${creationTime}.${fbclid}`;
        }
        webNearInfo2.utm_source = decodeURIComponent(params['utm_source'] || "Organic");
        webNearInfo2.utm_medium = decodeURIComponent(params['utm_medium'] || "");
        webNearInfo2.utm_campaign = decodeURIComponent(params['utm_campaign'] || "");
        webNearInfo2.utm_content = decodeURIComponent(params['utm_content'] || "");
        webNearInfo2.utm_term = decodeURIComponent(params['utm_term'] || "");
        webNearInfo2.utm_adset = decodeURIComponent(params['utm_adset'] || "");
        webNearInfo2.gclid = decodeURIComponent(params['utm_term'] || "");
        webNearInfo2.salesforce_uuid = decodeURIComponent(params['salesforce_uuid'] || "");
        webNearInfo2.msclkid = decodeURIComponent(params['msclkid'] || "");
        webNearInfo2.fbclid = fbclid;
        webNearInfo2.fbcId = fbc || null;
        webNearInfo2.fbpId = fbp || null;
        webNearInfo2.userAgent = userAgent,
          webNearInfo2.li_fat_id = decodeURIComponent(params['li_fat_id'] || "");

        webNearInfo2.user_id = visitor_id;
        webNearInfo2.user_timezone = v_timezone;
        //     webNearInfo2.l_page_url = "learn.ik" + getCookie("ik-landingpage");
        if ((referrer || '') != "") {
          webNearInfo2.l_page_url = "learn.ik/" + (referrer || '').split("/").pop();
        } else {
          webNearInfo2.l_page_url = "learn.ik/" + page_url.split("/").pop();
        }
        webNearInfo2.cta_page_url = "learn.ik" + cta_lp;
        webNearInfo2.webinar_type = webinarType;
        webNearInfo2.eventname = eventName;
        webNearInfo2.wr__referrer = referrer;
        webNearInfo2.wr__device = getDeviceType();

        webNearInfo2.webinar_lead_type = webinarType;
        webNearInfo2.bye_calendly_type = "";
        webNearInfo2.is_exit_intent_popup = "No";
        webNearInfo2.irclickid = decodeURIComponent(params['irclickid'] || "");
      }
      setHiddenFields2();

      document.addEventListener("webNearLoaded", function () {
        isCoreDataMissing && secondStepSecondRequest2(true);
      })

      async function pushToEndPoint2(endpoint) {
        let getCheckWebnear = webNearSlots2.querySelector('input[name="v2_slot"]:checked');
        webNearInfo2.eventStartTime = getCheckWebnear.value;
        webNearInfo2.eventEndTime = getCheckWebnear.getAttribute('data-endtime');
        webNearInfo2.inviteStartTime = getCheckWebnear.getAttribute('data-invitee_starttime');
        webNearInfo2.inviteEndTime = getCheckWebnear.getAttribute('data-invitee_endtime');

        let formData = {
          "First Name": webNearInfo2.firstName,
          "Last Name": webNearInfo2.lastName,
          "Email Address": webNearEmailAddress2.value,
          "ByeCalendlyType": webNearInfo2.bye_calendly_type,
          "webinar-type": webNearInfo2.webinar_type,
          "Webinar Lead Type": webNearInfo2.webinar_lead_type,
          "utm_source": webNearInfo2.utm_source,
          "utm_medium": webNearInfo2.utm_medium,
          "utm_campaign": webNearInfo2.utm_campaign,
          "utm_content": webNearInfo2.utm_content,
          "utm_adset": webNearInfo2.utm_adset,
          "utm_term": webNearInfo2.utm_term,

          "City": webNearInfo2.wr__city,
          "Device": webNearInfo2.wr__device,
          "Referrer": webNearInfo2.wr__referrer,
          "Region": webNearInfo2.wr__region,

          "gclid": webNearInfo2.gclid,
          "msclkid": webNearInfo2.msclkid,
          "fbclid": webNearInfo2.fbclid,
          "fbpId": webNearInfo2.fbpId,
          "fbcId": webNearInfo2.fbcId,
          "user_agent": webNearInfo2.userAgent,
          "user_id": webNearInfo2.user_id,
          "li_fat_id": webNearInfo2.li_fat_id,

          "cta_page_url": webNearInfo2.cta_page_url,
          "landing_page_url": webNearInfo2.l_page_url,
          "event_name": webNearInfo2.eventname,
          "user_timezone": webNearInfo2.user_timezone,
          "page_url": webNearInfo2.page_url,
          "site_url": webNearInfo2.site_url,
          "v_country": webNearInfo2.v_country,
          "salesforce_uuid": webNearInfo2.salesforce_uuid,
          "phone_number_full": webNearInfo2.fPhoneNumber,
          "is_exit_intent_popup": webNearInfo2.is_exit_intent_popup,
          "irclickid": webNearInfo2.irclickid,

          "Event Start Time": webNearInfo2.eventStartTime,
          "Event End Time": webNearInfo2.eventEndTime,
          "Invitee Start Time": webNearInfo2.inviteStartTime,
          "Invitee End Time": webNearInfo2.inviteEndTime,
          ...userIpAndBrowserInfo
        };

        let options = {
          method: 'POST',
          mode: "no-cors",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        };

        try {
          const sendData = await fetch(endpoint, options);
          return sendData;
        } catch (err) {
          console.error("P0: The Zapier Webhook Failed.", err);
        }
      }


      function hideError2() {
        getFnErrMsg2.setAttribute('err_status', false);
        getEmErrMsg2.setAttribute('err_status', false);
        getPhErrMsg2.setAttribute('err_status', false);
      }

      // First Form Submittion
      function fromSend1stStep2() {
        setHiddenFields2();

        let fullname = webNearFullName2.value.trim();
        let wEmail = webNearEmailAddress2.value;
        let fullPhoneNumber = webNearPhoneNumber2.value;

        //Hide errors
        webNearFullName2.addEventListener('input', hideError2);
        webNearEmailAddress2.addEventListener('input', hideError2);
        webNearPhoneNumber2.addEventListener('input', hideError2);
        webNearFullName2.addEventListener('focus', hideError2);
        webNearEmailAddress2.addEventListener('focus', hideError2);
        webNearPhoneNumber2.addEventListener('focus', hideError2);


        //Error check
        if ((fullname.length == 0) && (wEmail.length == 0) && (fullPhoneNumber.length == 0)) {
          getFnErrMsg2.setAttribute('err_status', true);
          getEmErrMsg2.setAttribute('err_status', true);
          getPhErrMsg2.setAttribute('err_status', true);
          track("info-e", "validation-general");
          return;
        } else if (!name_regex2.test(fullname) || fullname.length == 0) {
          getFnErrMsg2.setAttribute('err_status', true);
          track("info-e", "validation-name");
          return;
        } else if (!email_regex2.test(wEmail) || wEmail.length == 0) {
          getEmErrMsg2.setAttribute('err_status', true);
          track("info-e", "validation-email");
          return;
        } else if (!phone_regex2.test(fullPhoneNumber) || fullPhoneNumber.length == 0) {
          getPhErrMsg2.setAttribute('err_status', true);
          track("info-e", "validation-phone");
          return;
        } else {

          if (fullname.substring(0, fullname.indexOf(' ')) == '') {
            webNearInfo2.firstName = fullname.substring(fullname.indexOf(' ') + 1);
            webNearInfo2.lastName = fullname.substring(fullname.indexOf(' ') + 1);
          } else if (fullname.substring(fullname.indexOf(' ') + 1) == '') {
            webNearInfo2.firstName = fullname.substring(0, fullname.indexOf(' '));
            webNearInfo2.lastName = fullname.substring(0, fullname.indexOf(' '));
          } else {
            webNearInfo2.firstName = fullname.substring(0, fullname.indexOf(' '));
            webNearInfo2.lastName = fullname.substring(fullname.indexOf(' ') + 1);
          }

          try {
            dataLayer.push({
              'event': 'pa_new_webinar_registration_form_submitted',
              'webinar_name': webNearInfo.eventname
            });
          } catch (err) {
            console.log(err);
            track("info-e", "reporting-data-layer");
          }

          webNearInfo2.fPhoneNumber = "";
          if (typeof intlTelInputUtils == "undefined") {
            try {
              webNearInfo2.fPhoneNumber = `+${webNearPhoneNumberWri2.getSelectedCountryData().dialCode || ""}${getThePopupFrom2.querySelector(".fr_phone_fl")?.value}`;
            } catch (error) {
              console.error("Error while getting phone number", error);
              webNearInfo2.fPhoneNumber = getThePopupFrom2.querySelector(".fr_phone_fl")?.value;
            }
          } else {
            webNearInfo2.fPhoneNumber = webNearPhoneNumberWri2.getNumber(intlTelInputUtils.numberFormat.E164);
          }
          let zapUrl = "https://hooks.zapier.com/hooks/catch/11068981/340hd4j/";

          pushToEndPoint2(zapUrl)
            .then(() => {
              getThePopupFrom2.setAttribute("active_step", 2);
              document.querySelector("#webinar_progress_bar_container").setAttribute("ac_step", 2);
              track("info");
            }).catch((e) => {
              console.error(e);
              track("info-e", "flow-zapier");
            });
        }
      }


      // Second Form Submition
      function fromSend2ndStep2() {
        const getCheckWebnear = webNearSlots2.querySelector('input[name="v2_slot"]:checked');

        let utmm = visitor_id + ":" + webNearInfo2.v_country;
        let sf_uuid = v_timezone + ":learn.ik" + cta_lp + ":learn.ik" + getCookie("ik-landingpage");
        webNearInfo2.salesforce_uuid = sf_uuid;
        let utmstring = {
          assigned_to: "Interview Kickstart",
          invitee_first_name: webNearInfo2.firstName,
          invitee_last_name: webNearInfo2.lastName,
          invitee_email: webNearEmailAddress2.value,
          answer_1: webNearInfo2.fPhoneNumber,
          event_start_time: getCheckWebnear.value,
          event_end_time: getCheckWebnear.getAttribute('data-endtime'),
          utm_medium: utmm,
          salesforce_uuid: sf_uuid,
          whatsapp_consent: true
        };

        bake_cookie("from_cookie", utmstring);
        let pushUrl = is_webinar_1o1_eligible ? "https://hooks.zapier.com/hooks/catch/11068981/2dvpcc1/" : "https://hooks.zapier.com/hooks/catch/11068981/340hl1a/";
        pushToEndPoint2(pushUrl)
          .then(() => {
            getThePopupFrom2.setAttribute("active_step", 3);
            document.querySelector("#webinar_progress_bar_container").setAttribute("ac_step", 3);

            track("slot");
            secondStepSecondRequest2();
          }).catch((e) => {
            console.error(e);
            track("slot-e", "flow-zapier");
          });
      }


      const getDomainRole = getThePopupFrom2.querySelector('.gql_domain_select');

      const errDomEx = getThePopupFrom2.querySelector('.v2_dom_fild');

      let leadScoreData = {};

      getDomainRole.addEventListener('change', function () {
        errDomEx.setAttribute('err_status', false);
      })

      function fromSend3rdStep2() {
        let v2WorkExp = getThePopupFrom2?.querySelector(".exp_options:checked").value;
        let v2DomExp = getDomainRole.value;

        let gqlErrStatus = false;

        if (!v2DomExp) {
          gqlErrStatus = true;
          errDomEx.setAttribute('err_status', gqlErrStatus);
        }

        if (!gqlErrStatus) {
          let GQLformData = {
            'First Name': webNearInfo2.firstName,
            'Last Name': webNearInfo2.lastName,
            'Email Address': webNearEmailAddress2.value,
            utm_source: webNearInfo2.utm_source,
            utm_medium: webNearInfo2.utm_medium,
            utm_campaign: webNearInfo2.utm_campaign,
            utm_term: webNearInfo2.utm_term,
            gclid: webNearInfo2.gclid,
            msclkid: webNearInfo2.msclkid,
            "fbclid": webNearInfo2.fbclid,
            "fbpId": webNearInfo2.fbpId,
            "fbcId": webNearInfo2.fbcId,
            "user_agent": webNearInfo2.userAgent,
            user_id: visitor_id,
            user_timezone: v_timezone,
            v_country: v_country,
            phone_number_full: webNearInfo2.fPhoneNumber,
            'Event Start Time': webNearInfo2.eventStartTime,
            'Event End Time': webNearInfo2.eventEndTime,
            'Work Experience': v2WorkExp,
            'Role Domain': v2DomExp,
            'Interview Start Time': "",
            'Laid Off': "",
            'Is Student': "",
            salesforce_uuid: webNearInfo2.salesforce_uuid,
          };

          leadScoreService()
            .then(function (data) {
              leadScoreData = data;
            }).then(function () {
              GQLformData = { ...GQLformData, ...leadScoreData };
              try {
                dataLayer.push({
                  event: "wordpress_form_submitted",
                  formName: "Lead Qualifier Form",
                  expected_revenue: parseFloat(leadScoreData.expected_revenue.replace(/[^0-9.]/g, "")),
                })
              } catch (err) {
                console.log("error in data layer push", err);
              }
              let zapUrl = "https://hooks.zapier.com/hooks/catch/11068981/3409hxu/";

              sendRequestZapiar(zapUrl, GQLformData, track);
            });
        } else {
          track("gql-e", "validation-gql");
        }
      }

      async function leadScoreService() {
        const API_KEY = "cT8YFc92uylyqfQXWMMrFdLTiMA";
        const getCheckWebnear = webNearSlots2.querySelector('input[name="v2_slot"]:checked');

        let data = {
          formatted_date: getCheckWebnear.value,
          lead_email: webNearEmailAddress2.value,
          channel: webNearInfo2.utm_medium,
          role_domain: getDomainRole.value,
          interview_start_time: getCheckWebnear.value,
          sale_date: null,
          alumni_stats: 'New_Lead',
        }
        const payload = JSON.stringify({
          leads_stats: isSwitchUp !== "No" ? "SU" : "Others",
          ...data
        });

        let options = {
          method: "POST",
          body: payload,
          headers: { 'x-api-key': API_KEY, 'Content-Type': 'application/json' },
        }

        try {
          const response = await fetch('https://j466lvsvmbogck6ejb7vwogo6m0kuwjy.lambda-url.us-west-1.on.aws/', options);
          const result = await response.json();
          if (!result.email) result.email = webNearEmailAddress2.value;
          return result;
        } catch (e) {
          console.error(e)
        }
      }

      async function sendRequestZapiar(url, data, callback = null) {
        let options = {
          method: 'POST',
          mode: "no-cors",
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        };

        try {
          let response = await fetch(url, options);
          loadPagefield();
          getThePopupFrom2.setAttribute("active_step", 4);
          if (typeof callback === 'function') {
            callback("gql");
          }
        } catch (error) {
          if (typeof callback === 'function') {
            callback("gql-e", "Zapier Webhook Failed");
          }
          console.error("error in zapier webhook", error);
        }
      }

      async function secondStepSecondRequest2(forSlotAPI = false ) {

        //lead LeadCreatedTime
        const currentDateTime = new Date();
        const LeadCreatedTime = currentDateTime.toISOString().replace(/T/, ' ').replace(/\.\d+Z$/, ' UTC');

        function formatDateTime(dateTimeString) {
          const date = new Date(dateTimeString);
          const year = date.getUTCFullYear();
          const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
          const day = date.getUTCDate().toString().padStart(2, '0');
          const hours = date.getUTCHours().toString().padStart(2, '0');
          const minutes = date.getUTCMinutes().toString().padStart(2, '0');
          const seconds = date.getUTCSeconds().toString().padStart(2, '0');
          return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} UTC`;
        }

        let formattedStartDateTime = null;
        let formattedEndDateTime = null;
        if(forSlotAPI){
          const getCheckWebnear = webNearSlots2.querySelector('input[name="v2_slot"]:checked');
          formattedStartDateTime = formatDateTime(getCheckWebnear.value);
          formattedEndDateTime = formatDateTime(getCheckWebnear.getAttribute('data-endtime'));
        }
        let data = [{
          "Lead_Created_Time": forSlotAPI ? currentDateTime : LeadCreatedTime,
          "Lead_Name": webNearInfo2.firstName + ' ' + webNearInfo2.lastName,
          "Lead_First_Name": webNearInfo2.firstName,
          "Lead_Last__Name": webNearInfo2.lastName,
          "Lead_Email": webNearEmailAddress2.value,
          "Lead_Time_Zone": webNearInfo2.user_timezone,
          "Event_Type_Name": eventName,
          "Event_Start_Date_Time": formattedStartDateTime,
          "Event_End_Date_Time": formattedEndDateTime,
          "Cancellation_reason": "",
          "Mobile": webNearInfo2.fPhoneNumber,
          "UTM_Campaign": webNearInfo2.utm_campaign,
          "UTM_Source": webNearInfo2.utm_source,
          "UTM_Medium": webNearInfo2.utm_medium,
          "UTM_Term": webNearInfo2.utm_term,
          "UTM_Content": webNearInfo2.utm_content,
          "Tracking_ID": "",
          "User_ID": webNearInfo2.user_id,
          "Page_URL": encodeURIComponent(webNearInfo2.page_url),
          "Country": webNearInfo2.v_country,
          "Client_Timezone": webNearInfo2.user_timezone,
          "CTA_Page": encodeURIComponent(webNearInfo2.cta_page_url),
          "Landing_Page": encodeURIComponent(webNearInfo2.l_page_url),
          "Webinar_reg_type": "",
          "Webinar_Type": webNearInfo2.webinar_type,
          "Switchup_Lead": webNearInfo2.webinar_lead_type,
          "UUID": webNearInfo2.salesforce_uuid,
          "Click_History": "",
          "City": webNearInfo2.wr__city,
          "Device": webNearInfo.wr__device,
          "User_Agent": encodeURIComponent(navigator?.userAgent || ""),
          "Refferer": encodeURIComponent(webNearInfo2.wr__referrer),
          "Region": webNearInfo2.wr__region,
          "step": "s4"
        }];

        if (forSlotAPI) {
          data = [{
            ...data[0],
            "step": "s1_slotsAPI"
          }];
        }

        let options = {
          method: 'POST',
          headers: {
            'x-api-key': 'fm0X61U99b80d5SlGjrxFaWjgxIBylhX3LkfYGPN',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            dataset_id: "Marketing_data_new_logic",
            table_id: "Leads_Click_history",
            data: data,
          }),
          keepalive: true,
        };

        try {
          const response = await fetch('https://nlhtyrnugl.execute-api.us-west-1.amazonaws.com/prod', options);
          return response;
        } catch (err) {
          console.log(err);
        };
      }


      function loadPagefield() {
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];


        const getCheckWebnear = webNearSlots2.querySelector('input[name="v2_slot"]:checked');
        const getFullData = webinarSlots[parseInt(getCheckWebnear.getAttribute("slot-index"))];

        const getDayfield = document.querySelector('#v2-success-day');
        const getDatefield = document.querySelector('#v2-success-date');
        const getMonthfield = document.querySelector('#v2-success-month');
        const getTimefield = document.querySelector('#v2-success-time');

        getDayfield.innerHTML = getFullData.weekday;
        getDatefield.innerHTML = getFullData.day;
        getMonthfield.innerHTML = months[parseInt(getFullData.month) - 1];
        getTimefield.innerHTML = `${getFullData.hour}:${getFullData.minute} ${getFullData.am_or_pm}`;
      }
      const getV2Btn1 = getThePopupFrom2.querySelector('.step_btn_1');
      const getV2Btn2 = getThePopupFrom2.querySelector('.step_btn_2');
      const getV2Btn3 = getThePopupFrom2.querySelector('.step_btn_3');

      const getV2Back2 = getThePopupFrom2.querySelector('.step_back_2');
      const getV2Back3 = getThePopupFrom2.querySelector('.step_back_3');

      getV2Btn1.addEventListener("click", () => {
        try {
          fromSend1stStep2();
        } catch (error) {
          saveFormEventsActivity("info-e", null, null, "Error in 1st step");
        }
      });
      getV2Btn2.addEventListener("click", () => {
        try {
          fromSend2ndStep2();
        } catch (error) {
          saveFormEventsActivity("slot-e", null, null, "Error in 2nd step");
        }
      });
      getV2Btn3.addEventListener("click", () => {
        try {
          fromSend3rdStep2();
        } catch (error) {
          saveFormEventsActivity("gql-e", null, null, "Error in 3rd step");
        }
      });

      getV2Back2.addEventListener("click", function () {
        getThePopupFrom2.setAttribute("active_step", 1);
        document.querySelector("#webinar_progress_bar_container").setAttribute("ac_step", 1);

      })
      getV2Back3.addEventListener("click", function () {
        getThePopupFrom2.setAttribute("active_step", 2);
        document.querySelector("#webinar_progress_bar_container").setAttribute("ac_step", 2);
      })
    })
  })();
</script>